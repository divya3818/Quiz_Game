<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - QuizMaster</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Additional styles for voice controls */
        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .voice-btn {
            padding: 8px 15px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .voice-btn:hover {
            background-color: #3a5a80;
            transform: translateY(-2px);
        }
        
        .voice-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-btn.active {
            background-color: #2e7d32;
            box-shadow: 0 0 10px rgba(46, 125, 50, 0.5);
        }
        
        .voice-status {
            font-size: 14px;
            color: #666;
            margin-left: auto;
        }
        
        .mic-icon {
            width: 16px;
            height: 16px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-label {
            font-size: 14px;
            color: #444;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4a6fa5;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .auto-read-info {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="nav-logo">QuizMaster</a>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('progress') }}" class="nav-link">Your Progress</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="quiz-container">
            <div class="quiz-header">
                <h2>{{ category|title }} Quiz</h2>
                <div class="quiz-progress">
                    Question {{ question_num }} of {{ total_questions }}
                </div>
            </div>

            <!-- Voice Controls -->
            <div class="voice-controls">
                <button id="readQuestion" class="voice-btn">
                    <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                    Read Question
                </button>
                
                <div class="toggle-container">
                    <span class="toggle-label">Auto-Read Questions</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoReadToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <span id="voiceStatus" class="voice-status">Auto-read: Off</span>
                
                <div class="auto-read-info">
                    When enabled, questions will be automatically read when they appear.
                </div>
            </div>

            <div class="question-container">
                <h3 id="question-text">{{ question.question }}</h3>
                <form method="POST">
                    <div class="options">
                        {% for option in question.options %}
                        <label class="option">
                            <input type="radio" name="answer" value="{{ option }}" required>
                            <span>{{ option }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn-primary">
                        {% if question_num == total_questions %}Finish Quiz{% else %}Next Question{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const readQuestionBtn = document.getElementById('readQuestion');
            const autoReadToggle = document.getElementById('autoReadToggle');
            const voiceStatus = document.getElementById('voiceStatus');
            const questionText = document.getElementById('question-text').textContent;
            const options = document.querySelectorAll('.option span');
            
            // Check if browser supports Web Speech API
            if (!('speechSynthesis' in window)) {
                readQuestionBtn.disabled = true;
                autoReadToggle.disabled = true;
                voiceStatus.textContent = 'Text-to-speech not supported in your browser';
                return;
            }
            
            // Initialize speech synthesis
            const synth = window.speechSynthesis;
            let autoReadEnabled = false;
            
            // Function to read the question
            function readQuestion() {
                // Stop any ongoing speech
                if (synth.speaking) {
                    synth.cancel();
                    return;
                }
                
                // Create question text with options
                let fullText = questionText + ". Options: ";
                options.forEach((option, index) => {
                    fullText += `Option ${index + 1}: ${option.textContent}. `;
                });
                
                const utterance = new SpeechSynthesisUtterance(fullText);
                
                // Set a pleasant voice if available
                const voices = synth.getVoices();
                const englishVoice = voices.find(voice => 
                    voice.lang.startsWith('en-') && voice.localService === false
                );
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                    utterance.pitch = 1.1;
                    utterance.rate = 0.9;
                }
                
                synth.speak(utterance);
                
                // Update button appearance while speaking
                readQuestionBtn.classList.add('active');
                
                utterance.onend = function() {
                    readQuestionBtn.classList.remove('active');
                };
            }
            
            // Check if auto-read was previously enabled
            const savedAutoRead = localStorage.getItem('quizAutoRead');
            if (savedAutoRead === 'true') {
                autoReadToggle.checked = true;
                autoReadEnabled = true;
                voiceStatus.textContent = 'Auto-read: On';
                
                // Read the question automatically after a short delay
                setTimeout(readQuestion, 500);
            }
            
            // Event listeners
            readQuestionBtn.addEventListener('click', readQuestion);
            
            autoReadToggle.addEventListener('change', function() {
                autoReadEnabled = this.checked;
                
                if (autoReadEnabled) {
                    voiceStatus.textContent = 'Auto-read: On';
                    localStorage.setItem('quizAutoRead', 'true');
                    
                    // Read the current question when enabled
                    readQuestion();
                } else {
                    voiceStatus.textContent = 'Auto-read: Off';
                    localStorage.setItem('quizAutoRead', 'false');
                    
                    // Stop any ongoing speech when disabled
                    if (synth.speaking) {
                        synth.cancel();
                    }
                }
            });
            
            // Stop speech when leaving the page
            window.addEventListener('beforeunload', function() {
                if (synth.speaking) {
                    synth.cancel();
                }
            });
            
            // Form submission handler to prepare for next question
            const form = document.querySelector('form');
            form.addEventListener('submit', function() {
                // Stop any ongoing speech when moving to next question
                if (synth.speaking) {
                    synth.cancel();
                }
                
                // Store the auto-read setting for the next question
                localStorage.setItem('quizAutoRead', autoReadEnabled.toString());
            });
        });
    </script>
</body>
</html>